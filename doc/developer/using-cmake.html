<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Using CMake to build Crux</title>
  <style type="text/css" media="screen">
    body {margin: 72px;
  </style>
</head>
<body>
<h2>Using CMake to build Crux</h2>
<a href="http://www.cmake.org">CMake</a> is a tool for building sofware on multiple platforms.
It is similar in function to the autotools (autoconf and automake),
but CMake is easier to use and provides more sophisticated support 
for a wider array of platforms.
CMake also seems to build Crux more quickly than the automake tools.
<p/>
Documentation for CMake can be fournd <a
href="http://www.cmake.org/cmake/help/documentation.html">here</a>.
A CMake tutorial is <a href="http://www.cmake.org/cmake/help/cmake_tutorial.html">here</a>.
<p />
To use CMake you write a set of scripts specifying the build in the CMake language.  
Each of these scripts is named <code>CMakeLists.txt</code>.
The program <code>cmake</code> on a <code>CMakeLists.txt</code> file
and it generates the appropriate 'make' files or Visual Studio project files
need to perform the actual build.
Typically a master <code>CMakeLists.txt</code> in the root directory of a project points to
<code>CMakeLists.txt</code> files in each of the subdirectories involved in the build.
<p />
To use CMake on our lab computers you'll need to load the CMake module:
<pre>
module load cmake/latest
</pre>
In the root of the Crux project just run
<pre>
cmake .
</pre>
After cmake runs, just give the command 
<pre>
make
</pre>
to build the whole project, and
<pre>
make install
</pre>
to install it.
As usual 
<pre>
make clean
</pre>
will remove most existing targets and intermediate files.
Unfortunately <code>make clean</code> will leave behind
old copies of the build of the external components.
To remove those as well, run the command
<pre>
make deep-clean
</pre>
from the project root.
This will first perform <code>make clean</code>
and then remove all the build files for the external components.
This will force the external components to be rebuilt from scractch
the next time <code>make</code> is run.
To clean up the external components without running <code>make clean</code>,
run
<pre>
make deep-clean-external
</pre>
<p />
There is no need to re-run cmake unless you want to change
the build configuration.
<p />
<h2>Setting the installation directory</h2>
The instructions above will build Crux in a default configuration.
In particular it will try to install Crux in <code>/usr/local</code>.
To set a different installation location use
<pre>
cmake -DCMAKE_INSTALL_PREFIX:PATH=$HOME/crux .
</pre>
The <code>-DCMAKE_INSTALL_PREFIX:PATH=$HOME/crux</code> option will direct
<code>make install</code>
to install Crux in a subdirectory of your home directory.
<h2>Setting the build type</h2>
On UNIX platforms CMake will default to a build with
optimization turned off and no debugging symbols.
This is not the most useful configuration.
To turn optimizations on, you must explicitly request 
a <code>Release</code> build:
<pre>
cmake -DCMAKE_BUILD_TYPE=Release . # Build with optimizations turned on, and debug symbols off
make clean # remove any existing object files
make
</pre>
If you'd like a debug build with optimization turned off
but debug symbols included, use the command:
<pre>
cmake -DCMAKE_BUILD_TYPE=Debug . # Build with optimizations turned off, and debug symbols on
make clean # remove any existing object files
make
</pre>
If you'd like a debug build with optimizations turned on but debug symbols included,
use
<pre>
cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo . # Build with optimizations turned on, and debug symbols on
make clean # remove any existing object files
make
</pre>
<h2>Turning on verbose build mode</h2>
By deault CMake will only show you warnings and error messages from the build.
If you'd like to see the actuall commands executed during the build,
you can turn on verbose make with this command:
<pre>
cmake -DCMAKE_VERBOSE_MAKEFILE=ON .
make
</pre>
If typing these long configuration options seems painful CMake provides a
custom proprerty editor that uses the <code>curese</code> library to create
a point and click settings editor. Use the command
<pre>ccmake</pre> 
(only available  on 64-bit systems).
<p />
<h2>Out of source builds</h2>
CMake supports "out of source builds".
This performs the build in a separate directory from the actual source tree.
It turns out that this is very handy for several reasons. 
It lets you keep separate debug and release builds,
it makes for better integration with TeamCity or Jenkins,
and it keeps random intermediate files from being inadvertently included
in the source release.
<p />
To perform an out of source build of Crux: 
<ul>
<li>
Create a director where you want to do the build.
</li>
<li>
Move into that directory and run:
<pre>
  cmake [CMake options] &lt;path to Crux source directory&gt;
  make
</pre>
</li>
</ul>
For example,
if the Crux source tree is in <code>crux-source</code>
and you wanted to create separate debug and release builds you could 
run the following commands:
<pre>
mkdir debug
mkdir release
cd debug
cmake -DCMAKE_BUILD_TYPE=Debug ../crux-src
make
cd ../release
cmake ../crux-src
make
</pre>
Or, if you wanted to build the source and binary distributions for Crux:
<pre>
mkdir source-dist
mkdir linux-x86_64-dist
cd source-dist
cmake ../crux-src
make package_source
cd ../linux-x86_64-dist
cmake ../crux-src
make package
</pre>
<b>Note</b>:
if you've already done a build in the source tree
CMake won't let you do an out of source build.
You'll first have to clean up all the CMake intermediate files.
In the Crux source root run:
<pre>
make deep-clean
</pre>
<h2>Running smoke tests</h2>
I've also added a target to run the smoke-tests:
<pre>
make smoke-tests
</pre>
</body>
</html>
