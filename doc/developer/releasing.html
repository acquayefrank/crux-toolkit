<html>
 <title>Notes on releasing new versions of Crux</title>
<body>
 <h2 align=center>Notes on releasing new versions of Crux</h2>

<p><i>Note: A detailed <a href=#todo>checklist</a> is at the bottom of
    this page</i>

<h3>Introduction</h3>
After every successful commit to the Crux SVN repository
our TeamCity server automatically publishes the current source distribution
and binaries for all platforms to the Crux web site.
As functionality milestones are achieved
we also publish stable, versioned releases.
This document describes how to publish a versioned release.

<h3>Before you begin</h3>
<p>Confirm that the TeamCity server successfully built Crux from the current
  repository trunk on all platforms, and that the smoke and performance tests all 
  passed on the 64-bit Linux build.
  Update the release notes
  (crux/doc/user/release-notes.html).  At the very least, the date
  will need to be added. 
  You can also make sure that the default.params file is up-to-date by running
  write-default-params.sh in crux/src/c.
  <!--
    This process needs to be updated! Should we have team-city automatically
    update default.params in the repository?
  -->

<h3>Branching</h3>
In SVN tags and branches are really the same,
but tags are traditionally used
for branches intended to be permanent, named, versions.
<p>Each release of Crux should be given its own branch in the 
<code>crux/tags</code> subdirectory of the Crux SVN repository.
Bugs reported for the release are fixed in this branch and then
merged into the trunk.
<p/>
For example:
<pre>
svn copy \ 
  svn+ssh://charlesegrant@svn.code.sf.net/p/cruxtoolkit/code/crux/trunk \
  svn+ssh://charlesegrant@svn.code.sf.net/p/cruxtoolkit/code/crux/tags/crux-2.1 \
</pre>
All the edits that follow should take place in the release branch
and then be merged back into the trunk.
<h3>Update the version number</h3>
<p>Each time new files are made available for download, the version
number should increment by 0.01 for minor releases or by 0.1 for major
releases. The version number is maintained in CMakeLists.txt in the
root Crux directory in the lines
<pre>
set (CPACK_PACKAGE_VERSION_MAJOR "X")
set (CPACK_PACKAGE_VERSION_MINOR "XX")
</pre>
This controls the numbering of packages and what is reported by the 
<code>--version</code> option.
</p>

<h3>Prepare a static tarball of ProteoWizard</h3>
The normal build of Crux pulls the latest version of ProteoWizard 
from the SVN repository.
This is a moving target, and may result in bugs or break
the build as the ProteoWizard team makes changes. 
For formal releases we download the current version of ProteoWizard
and save it into as a fixed tarball on our website.
When users build the release from source, this tarball is downloaded,
and used to build the ProteoWizard libraries.
<p/>
The script <code>src/external/download-pwiz-tarball.sh</code>
can be used to download a copy of the ProteoWizard source tarball
into the current directory.
It can then be 
<a href="crux-sourceforge.html">copied</a> into the download directory for the new release on the
<code>crux-toolkit</code> web site.
<h3>Modify the Crux build to use the new ProteoWizard tarball</h3>
Crux's build of ProteoWizard is controled in <code>ext/CMakeLists.txt</code>.
Open that file and look for the comment:
<pre>
# Download and build a partial distribution of the pwiz source
# from the ProteoWizard TeamCity repository.
</pre>
Under that comment there will be two <code>if-else</code> blocks conditional on
the CMake variable <code>USE_LATEST_PWIZE</code> (one for UNIX systems and one
for Windows).
In each of the <code>else</code> blocks there will be a URL parameter in a call
to <code>ExternalProject_Add()</code>.
Update this URL to point to the new ProteoWizard tarball.
</pre>
<h3>Update the documentation and the download page</h3>
Make sure that the release notes reflect all the changes since the last
release.
Update 
<code>doc/user/download/index.html</code>
and
<code>doc/user/download/download.php</code>
to refer to the new release.
You'll need to update the value of the <code>release_button</code>
in <code>index.html</code> and the filenames listed for the
<code>release_button</code> POST handler in
<code>download.php</code>.
<h3>Perform a local build</h3>
Once you've made the above changes perform a build on build on each platform
and generate the binary packages. On 64-bit Linux make sure the smoke tests
pass and build a source package.
<h3>Update the TeamCity build tasks</h3>
Once you statisfied with the build you'll also need
to add the TeamCity tasks for building Crux on each of the platforms,
and for copying the resulting artifacts to the website.
<a href="crux-sourceforge.html" >Log on</a> to the <code>crux-toolkit</code> server.
Create a subdirectory for the new release in 
<code>/home/project-web/cruxtoolkit/htdocs/download</code>

<h3>Updating the website</h3>
<p>The public crux website is at
 <code>/var/noble/www/htdocs/proj/crux</code>
 and its address is http://noble.gs.washington.edu/proj/crux/.  The
<code>proj/crux/</code> directory should contain all of the files and
 sub-directories of <code>crux/doc/user/</code>.  The the target
 <code>webpage</code> in <code>crux/doc/user</code> will copy all
 necessary files to the web directory. The login/password
 for the downloads page is <code>crux</code> and <code>warm.Brandy</code>.

<a name="todo">
<h3>Checklist</h3></a>
<p>Here is a list of steps to follow, roughly in this order</p>
<ol>
<li>Create a release branch.
<li>Do a clean checkout of the release branch.
<h4>Update documentation</h4>
<li>Change version number in <code>crux/CMakeLists.txt</code>.
<li>Look at the SVN log since the last release and update release
  notes accordingly.
<li>Change the <code>crux/doc/user/download/index.html</code> page.
<h4>Build and test</h4>
<li>Build.
<li>Check unit and smoke tests.
<li>Check version number with <code>crux version</code>.
<li>Commit changes.
<h4>Create files for distribution</h4>
<li>Create packages
  <ul> 
    <li><code>cmake ..</code>
    <li><code>make package_source</code>
    <li><code>make package</code>
    <li><code>make checksum</code>
  </ul>
You should now have these files:
  <ul>
   <li>crux_1.xx.tar.gz
   <li>crux_1.xx.tar.gz.md5sum.txt
   <li>crux_1.xx-PLATFORM.zip
   <li>crux_1.xx-PLATFORM.zip.md5sum.txt
  </ul>

<li>Repeat the build and package steps for remaining platforms.  Note
  that you do not need to package up the source files again.
<h4>Check the distribution files</h4>
<li>Unpack and build the source file tarballs.
<li>Unpack and run the binary files.  <i>You may want to ask someone
    else to do these steps on different computers.</i>
<h4>Update the website</h4>
<li>Move the distribution files to <code>crux/doc/user/download</code>
and <code>crux/doc/user/open_source_download</code>.
<li>Copy the documentation and distribution files to the website with
<code>make webpage</code> from <code>crux/doc/user</code>.
<li>Test that the links all work.
<li>Send a message to the crux users list announcing the new release.
</ol>
</body>
</html>
