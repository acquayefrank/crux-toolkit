#!/bin/bash
if [[ $# != 2 ]]
then 
  echo "$0: two arguments allowed <ms2 file> <fasta file>" 1>&2
  exit 1
fi

if [[ ! -f "$1" || ! -f "$2" ]]
then 
  echo "Error: file or directiry does not match " 1>&2
  exit 1
fi

if [[ ! -f "crux_parameter" ]]
then
    echo "There is no crux_parameter file, thus all runs will be done by \
default settings"
fi

echo "Should I make new index? y|n"
read -e  ANSWER

#Check if we should make index?
if [[ "$ANSWER" == "y" ]]
then
    #make index
    echo "creating index"
    
    count=`ulimit -n`
    if [ $count -lt 2000 ]
        then
        #set file handle count, must have root permission
        ulimit -n 1000000
    fi
    
    #now creating real index
    (time create_index --parameter-file curx_parameter --cleavages all \
        --missed-cleavages --verbosity 100  --redundancy unique $2) &> index_creation_result    
fi

#first remove any pre existing *.dta files
rm -rf *.dta

#make .dta files for Sequest
./ms22dta.pl $1

#now run Sequest and Crux compare and plot runtime
python compare_runtime.py $1 $2

#now that were are done, remove all *.dta files
#rm -rf *.dta


